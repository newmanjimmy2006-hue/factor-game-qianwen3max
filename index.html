<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="stylesheet" href="css/badges-wall.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>因式分解挑战 - macOS版</title>
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
</head>
<body>
    <!-- macOS风格菜单栏 -->
    <div class="menubar">
        <div class="menubar-left">
            <span class="apple-logo">🍎</span>
            <span class="app-name">因式分解挑战</span>
            <span class="menu-item" id="menu-file">文件</span>
            <span class="menu-item" id="menu-edit">编辑</span>
            <span class="menu-item" id="menu-view">视图</span>
            <span class="menu-item" id="menu-help">帮助</span>
        </div>
        <div class="menubar-right">
            <span class="menu-icon" id="btn-badges-wall" title="徽章墙">🏆</span>
            <span class="menu-icon" id="btn-stats">📊</span>
            <span class="menu-icon" id="btn-settings">⚙️</span>
            <span class="menu-time" id="menu-time">12:00</span>
        </div>
    </div>

    <!-- 主窗口（macOS风格） -->
    <div class="main-window">
        <!-- 标题栏 -->
        <div class="window-titlebar">
            <div class="window-controls">
                <span class="window-btn close"></span>
                <span class="window-btn minimize"></span>
                <span class="window-btn maximize"></span>
            </div>
            <div class="window-title">二次三项式因式分解</div>
            <div class="window-spacer"></div>
        </div>

        <!-- 工具栏 -->
        <div class="toolbar">
            <div class="toolbar-section">
                <button class="toolbar-btn active" data-level="easy" title="初级">
                    <span class="toolbar-icon">🌱</span>
                    <span class="toolbar-label">初级</span>
                </button>
                <button class="toolbar-btn" data-level="medium" disabled title="中级">
                    <span class="toolbar-icon">🧮</span>
                    <span class="toolbar-label">中级</span>
                </button>
                <button class="toolbar-btn" data-level="hard" disabled title="高级">
                    <span class="toolbar-icon">🏆</span>
                    <span class="toolbar-label">高级</span>
                </button>
                <button class="toolbar-btn" data-level="random" disabled id="btn-random" title="随机">
                    <span class="toolbar-icon">🎲</span>
                    <span class="toolbar-label">随机</span>
                </button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-section stats-section">
                <div class="stat-item">
                    <span class="stat-value" id="total-score">0</span>
                    <span class="stat-name">总分</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="game-time">00:00</span>
                    <span class="stat-name">时间</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="streak">0</span>
                    <span class="stat-name">连击</span>
                </div>
                <div class="stat-item fatigue-item" id="fatigue-box" title="疲劳度">
                    <span class="stat-value" id="fatigue-level">100%</span>
                    <span class="stat-name">收益</span>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="window-content">
            <!-- 左侧：题目区 -->
            <div class="content-left">
                <!-- 题目卡片 -->
                <div class="question-card">
                    <div class="question-header">
                        <span class="question-label">将下列二次三项式分解因式</span>
                        <span class="question-progress">
                            <span id="progress-text">1 / 20</span>
                        </span>
                    </div>
                    <div class="expression-container">
                        <div class="expression" id="expression">x^2 + 5x + 6</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-track">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                    </div>
                </div>

                <!-- 答题区 -->
                <div class="answer-section">
                    <div class="slots-container">
                        <div class="slot-wrapper">
                            <div class="slot" data-slot="0">
                                <span class="slot-placeholder">?</span>
                            </div>
                            <span class="slot-label">因式一</span>
                        </div>
                        <span class="operator">×</span>
                        <div class="slot-wrapper">
                            <div class="slot" data-slot="1">
                                <span class="slot-placeholder">?</span>
                            </div>
                            <span class="slot-label">因式二</span>
                        </div>
                    </div>

                    <!-- 选项网格 -->
                    <div class="options-grid" id="options"></div>

                    <!-- 控制按钮 -->
                    <div class="controls">
                        <button class="mac-btn btn-primary" id="btn-submit">
                            <span class="btn-icon">✓</span>
                            <span>提交答案</span>
                        </button>
                        <button class="mac-btn btn-success" id="btn-next" hidden>
                            <span class="btn-icon">→</span>
                            <span>下一题</span>
                        </button>
                        <button class="mac-btn btn-secondary" id="btn-reset">
                            <span class="btn-icon">↺</span>
                            <span>重置</span>
                        </button>
                        <button class="mac-btn btn-info" id="btn-hint">
                            <span class="btn-icon">💡</span>
                            <span>提示</span>
                        </button>
                        <button class="mac-btn btn-danger" id="btn-answer" hidden>
                            <span class="btn-icon">👁</span>
                            <span>查看答案</span>
                        </button>
                    </div>

                    <!-- 消耗品按钮 -->
                    <div class="item-controls">
                        <button class="mac-btn item-btn" id="btn-use-skip" title="使用跳过卡">
                            <span class="btn-icon">⏭️</span>
                            <span>跳过</span>
                            <span class="item-count" id="skip-count">0</span>
                        </button>
                        <button class="mac-btn item-btn" id="btn-use-double" title="使用双倍积分卡">
                            <span class="btn-icon">💎</span>
                            <span>双倍</span>
                            <span class="item-count" id="double-count">0</span>
                        </button>
                    </div>

                    <!-- 反馈区 - 初始隐藏 -->
                    <div class="feedback" id="feedback" hidden>
                        <div class="feedback-icon"></div>
                        <div class="feedback-text"></div>
                    </div>
                </div>
            </div>

            <!-- 右侧：信息面板 -->
            <div class="content-right">
                <div class="info-panel">
                    <div class="info-card">
                        <span class="info-value" id="current-score">0</span>
                        <span class="info-label">当前得分</span>
                    </div>
                    <div class="info-card">
                        <span class="info-value" id="current-time">00:00</span>
                        <span class="info-label">本题用时</span>
                    </div>
                </div>

                <!-- 提示面板 -->
                <div class="hint-panel" id="hint-panel" hidden>
                    <div class="hint-header">
                        <span class="hint-icon">💡</span>
                        <span>解题提示</span>
                    </div>
                    <p id="hint-content"></p>
                </div>

                <!-- 最近徽章 -->
                <div class="badges-showcase" id="badges-showcase">
                    <div class="showcase-header">
                        <span>🏅 最近获得</span>
                        <span class="view-all" id="view-all-badges">查看全部 →</span>
                    </div>
                    <div class="badge-list" id="recent-badges">
                        <div class="empty-badges-hint">还没有获得徽章，开始挑战吧！</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 草稿区（macOS风格，右下角） -->
    <div class="scratchpad" id="scratchpad">
        <div class="scratchpad-header">
            <span class="scratchpad-title">📝 草稿纸</span>
            <button class="scratchpad-clear" id="scratchpad-clear" title="清空">⌫</button>
        </div>
        <canvas id="scratchpad-canvas" width="280" height="200"></canvas>
        <div class="scratchpad-tools">
            <button class="tool-btn active" data-tool="pen" title="画笔">✏️</button>
            <button class="tool-btn" data-tool="eraser" title="橡皮">🧼</button>
            <div class="color-picker">
                <span class="color-btn active" data-color="#1a1a1a" style="background: #1a1a1a;"></span>
                <span class="color-btn" data-color="#dc2626" style="background: #dc2626;"></span>
                <span class="color-btn" data-color="#2563eb" style="background: #2563eb;"></span>
                <span class="color-btn" data-color="#16a34a" style="background: #16a34a;"></span>
            </div>
        </div>
    </div>

    <!-- 商店按钮 -->
    <button class="shop-toggle" id="shop-toggle">🛒 商店</button>

    <!-- 商店面板 -->
    <div class="shop-panel" id="shop-panel" hidden>
        <div class="shop-header">
            <h3>🛒 积分商店</h3>
            <span class="shop-points">💰 <b id="shop-points">0</b></span>
            <button class="shop-close" id="shop-close">×</button>
        </div>
        <div class="shop-tabs">
            <button class="shop-tab active" data-tab="functional">功能</button>
            <button class="shop-tab" data-tab="theme">主题</button>
            <button class="shop-tab" data-tab="limited">限定</button>
        </div>
        <div class="shop-content" id="shop-content"></div>
    </div>

    <!-- 徽章墙 -->
    <div class="badges-wall" id="badges-wall" hidden>
        <div class="wall-content">
            <div class="wall-header">
                <h3>🏆 徽章墙</h3>
                <button class="wall-close" id="wall-close">×</button>
            </div>
            <div id="wall-content">
                <div style="text-align: center; padding: 40px; color: var(--gray-400);">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 主题选择器 -->
    <div class="theme-picker" id="theme-picker" hidden>
        <div class="theme-picker-header">
            <h4>🎨 选择主题</h4>
            <button class="theme-picker-close" id="theme-picker-close">×</button>
        </div>
        <div class="theme-list" id="theme-list"></div>
    </div>

    <!-- 设置面板 -->
    <div class="settings-panel" id="settings-panel" hidden>
        <div class="settings-header">
            <h4>⚙️ 设置</h4>
            <button class="settings-close" id="settings-close">×</button>
        </div>
        <div class="settings-content">
            <div class="setting-item">
                <span>音效</span>
                <label class="toggle">
                    <input type="checkbox" id="setting-sound" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>动画效果</span>
                <label class="toggle">
                    <input type="checkbox" id="setting-animation" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>显示草稿区</span>
                <label class="toggle">
                    <input type="checkbox" id="setting-scratchpad" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>当前主题</span>
                <button class="mac-btn btn-secondary" id="btn-change-theme">更改主题</button>
            </div>
        </div>
    </div>

    <canvas id="confetti"></canvas>

    <dialog class="modal" id="modal">
        <div class="modal-content">
            <h3>📖 详细解答</h3>
            <div class="solution">
                <p class="solution-q">题目：<span id="modal-q"></span></p>
                <div class="steps" id="modal-steps"></div>
                <p class="solution-a">答案：<span id="modal-a"></span></p>
            </div>
            <button class="mac-btn btn-primary" id="btn-close">继续挑战</button>
        </div>
    </dialog>

    <!-- 徽章获得弹窗 -->
    <div class="badge-popup" id="badge-popup" hidden>
        <div class="badge-popup-content">
            <div class="badge-popup-icon" id="badge-popup-icon"></div>
            <h4>获得徽章！</h4>
            <p id="badge-popup-name"></p>
            <p class="badge-popup-desc" id="badge-popup-desc"></p>
        </div>
    </div>

    <!-- 【修复】调整脚本加载顺序：工具库 -> 配置 -> 业务逻辑 -->
    <script src="js/utils.js"></script>
    <script src="js/config.js"></script>
    <script src="js/Badge.js"></script>
    <script src="js/Shop.js"></script>
    <script src="js/Question.js"></script>
    <script src="js/Option.js"></script>
    <script src="js/Game.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Initialize KaTeX rendering
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });
            }
        });
    </script>
</body>
</html>